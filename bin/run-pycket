#! /bin/bash
PROGRAM=`echo $0 | sed 's%.*/%%'`
PROGDIR="$(cd `dirname $0`; echo $PWD)"

if [ ! -z "$ZSH_VERSION" ]; then
  setopt shwordsplit
fi

BENCHDIR="$(dirname $PROGDIR)"
PYCKETDIR="$BENCHDIR/pycket"
PYCKET="${PYCKET:-pycket-c}"
PYCKET_BIN="${PYCKET_BIN:-$PYCKETDIR/$PYCKET}"
# sorry, sam
PYCKET_PRELUDE="(require racket/private/map racket/private/kw-file)"

if [ $# -lt 2 ]; then
    echo "No."
    exit -1
fi

VARIABLE=$1
shift
BENCHMARK=$1
shift

if [ "$VARIABLE" = "PURE" ]; then
    OUT="src/${BENCHMARK}.rkt"
else
    OUT="racket/${BENCHMARK}${VARIABLE}.rkt"

    if egrep -q 'set-c[ad]r!' "src/${BENCHMARK}.scm" ; then
        RFRS=" r5rs"
    else
        RFRS=""
    fi

    printf "(module %s pycket/wrap%s %s)\n" \
           "${BENCHMARK}" "${RFRS}" "${VARIABLE:1}" \
           > "$OUT";
fi

exec $PYCKET_BIN "$OUT" "$@"
