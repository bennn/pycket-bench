#! /bin/sh
PROGRAM=`echo $0 | sed 's%.*/%%'`
PROGDIR="$(cd `dirname $0`; echo $PWD)"

if [ ! -z "$ZSH_VERSION" ]; then
  setopt shwordsplit
fi

BENCHDIR="$(dirname $PROGDIR)"
PYCKETDIR="$BENCHDIR/pycket"
PYCKET="${PYCKET:-pycket-c}"
PYCKET_BIN="${PYCKET_BIN:-$PYCKETDIR/$PYCKET}"
PYCKET_PRELUDE=""

if [ $# -lt 2 ]; then
    echo "No."
    exit -1
fi

VARIABLE=$1
shift
BENCHMARK=$1
shift


BENCH_FILE="${BENCHMARK}.scm"
OUT="pycket/${BENCHMARK}${VARIABLE}.rkt"

if egrep -q 'set-c[ad]r!' "src/$BENCH_FILE" ; then
    MCONS="-mcons";
    PYCKET_PRELUDE="(require racket/mpair compatibility/mlist)"
else
    MCONS=""
fi

printf "`cat configuration/pycket.tmpl`\n" "pycket #:stdlib" \
       "$PYCKET_PRELUDE" \
        "pycket" "$MCONS" "pycket" "$VARIABLE" \
       "$BENCH_FILE" > "$OUT";

exec $PYCKET_BIN "$@" "$OUT" $EXTRA_ARG
