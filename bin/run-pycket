#! /bin/bash
PROGRAM=`echo $0 | sed 's%.*/%%'`
PROGDIR="$(cd `dirname $0`; echo $PWD)"

if [ ! -z "$ZSH_VERSION" ]; then
  setopt shwordsplit
fi

BENCHDIR="$(dirname $PROGDIR)"
PYCKETDIR="$BENCHDIR/pycket"
PYCKET="${PYCKET:-pycket-c}"
PYCKET_BIN="${PYCKET_BIN:-$PYCKETDIR/$PYCKET}"
# sorry, sam
PYCKET_PRELUDE="(require racket/private/map racket/private/kw-file)"

if [ $# -lt 2 ]; then
    echo "No."
    exit -1
fi

VARIABLE=$1
shift
BENCHMARK=$1
shift


BENCH_FILE="${BENCHMARK}.scm"
OUT="pycket/${BENCHMARK}${VARIABLE}.rkt"

if egrep -q 'set-c[ad]r!' "src/$BENCH_FILE" ; then
    MCONS="/mcons";
    MCONSDEF="-mcons"
else
    MCONS=""
    MCONSDEF=""
fi

printf "`cat configuration/pycket.tmpl`\n" "pycket$MCONS" \
       "$PYCKET_PRELUDE" \
        "pycket" "$MCONSDEF" "pycket" "$VARIABLE" \
       "$BENCH_FILE" > "$OUT";

exec $PYCKET_BIN "$@" "$OUT" $EXTRA_ARG
